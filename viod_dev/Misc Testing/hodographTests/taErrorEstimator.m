close all
clear;clc

addpath('..\functions')
addpath('..\..\..\journal\cases')

[~,eccVect,TA,~,~] = load_orbit_cases('taVect',linspace(0,340,35));

mu = 1;
a  = 1;
e  = 0.1;

period = 0.1;
period = period * 2*pi;

numObsv = 3;
% select the nth observation's position error for comparison
selObsv = 1;

errVect = nan(size(TA));
dfVect = nan(size(TA));

% uniform TRUE anomaly data
% generated using load_orbit_cases('taVect',linspace(0,340,35));
errDat = ...
{[0.00843167887535579 0.00858187551938632 0.00880397886390709 0.00910433902013742 0.00948327931971143 0.00993062031501432 0.0104620420940402 0.0110777593830474 0.011778147893758 0.0125407656230087 0.0133445799975899 0.0141669914484145 0.0149834692269328 0.0157607295105275 0.0164402175724927 0.0169535778990955 0.0172833541569205 0.0174225536335081 0.017345088145464 0.0170508637028819 0.0165797040533367 0.0159339214990524 0.0151860419957048 0.0143614933084215 0.0134943735854853 0.0126608637567441 0.0118836984928628 0.0111754543925682 0.0105397161607045 0.0099847471673665 0.00951984039093976 0.00914487443333345 0.00884298464708947 0.00860537808576814 0.0084469918626321 0.00836777144986161;0.00204627680785391 0.00220932771516 0.00241890015337382 0.00268811827450844 0.00303620078091713 0.00349347268707504 0.0041038870625653 0.00493571280174168 0.00608823124719254 0.00770482126614591 0.00999904214759944 0.0132725561506954 0.0179204204914248 0.0244035888460873 0.0330164786098027 0.0434914045161776 0.0544431998051677 0.0631815474590916 0.0664896617942976 0.0624672704896717 0.0521456038570608 0.0389920303133354 0.0266098389371924 0.0170016718577991 0.0104793381344933 0.00649505407243704 0.00423817257561735 0.00302158801050047 0.0023831908651556 0.00204175590032164 0.00185817720522519 0.00176490536116474 0.0017273818586134 0.00172891646236853 0.00176203227251572 0.00182380558536983;0.000566840003176903 0.000600402145183606 0.000640143737743093 0.00068733522250973 0.000743845246971494 0.000812510132212842 0.000897620309102113 0.00100603210299707 0.00114941879008959 0.001348953144111 0.00164604817260326 0.00212806506716626 0.00299730814753862 0.00477601748213704 0.00896973248404216 0.020411705664166 0.0554091354164191 0.156883069375184 0.317189821983829 0.270984720337589 0.0815824275041075 0.00747921696982968 0.00102882284658583 0.000837394923527192 0.000717073144857398 0.000632466562389877 0.000572048203119904 0.000529378988782477 0.000500332124106034 0.000482000129097621 0.000472307263138675 0.000469753672904089 0.000473266205051946 0.000482103139511621 0.000495807247326145 0.000514159818230216];...
 [0.00342520459217837 0.00348623334221526 0.00357646160235465 0.00369847920297804 0.00385241993024921 0.00403415659995503 0.0042500608103004 0.00450023803011844 0.00478479613882796 0.00509461276424668 0.00542115871914764 0.00575526659534515 0.0060869101388523 0.00640264844607171 0.006678697590638 0.00688718946210672 0.00702104523647005 0.00707756696535585 0.00704607532686608 0.0069265514430938 0.00673514206689215 0.00647280791006888 0.00616899918227696 0.00583401566564335 0.00548175747765385 0.0051431148359675 0.00482734218250964 0.00453964464099997 0.00428139409187392 0.00405595433857288 0.00386714019714136 0.00371483002750186 0.00359219287191595 0.00349569850337687 0.00343139975989307 0.00339922912402679;0.000831269177518692 0.000897507042206851 0.000982642827353072 0.00109200966681987 0.00123341515539954 0.00141917739152959 0.00166715482457704 0.00200508431679924 0.00247327937810485 0.00312999849233908 0.00406197473458093 0.00539175397845667 0.00727976693583291 0.00991325910086569 0.0134118795021168 0.0176668666773724 0.0221152551102151 0.0256646174905967 0.0270086102956584 0.0253748171117111 0.0211823165779161 0.0158392572630231 0.0108094359290558 0.00690643331377653 0.00425693581885948 0.0026384219262318 0.00172164001685203 0.00122744238573098 0.000968120386740929 0.000829420334461233 0.000754848692887501 0.000716961286238355 0.000701719298856623 0.000702343395025049 0.000715796512712079 0.000740890428345186;0.000230270659566392 0.000243904769666747 0.00026004917516307 0.00027922003751275 0.000302176514734826 0.000330070760267423 0.000364645615500188 0.000408686484409033 0.00046693557770228 0.000547993870845551 0.000668683801484616 0.000864493166264748 0.00121760009977634 0.00194013343195062 0.00364357315237132 0.00829059343587778 0.0224998550285912 0.0636810737150642 0.128795203449065 0.110053743112414 0.0331332948565562 0.00303821888597085 0.00041794261333665 0.000340178897498958 0.000291300183397631 0.000256930072332672 0.000232386059696195 0.000215052336955552 0.000203252495547458 0.000195805429247442 0.000191867876266674 0.000190830578242264 0.000192257564937036 0.000195847506865195 0.000201414640443444 0.000208870116646772];...
 [0.000984460278086915 0.0010020029947587 0.00102793660811691 0.00106300689013015 0.00110725263703331 0.00115948881128305 0.00122154689837171 0.00129345985783979 0.00137525236080501 0.00146430175495519 0.00155815866417142 0.00165419003836879 0.00174950566365163 0.00184025349050383 0.00191959799910998 0.00197951532626302 0.0020179727448374 0.00203421453581041 0.00202516008252305 0.00199080671918559 0.00193579068131282 0.00186039135391325 0.00177307142351806 0.00167678723663283 0.00157554076357182 0.00147820230557162 0.00138743444730109 0.00130474678756562 0.0012305217876818 0.00116572718920186 0.00111146501828116 0.00106769013572142 0.00103244203549925 0.00100471190058226 0.000986237280662958 0.000976992437219432;0.000238921323822846 0.000257959375997448 0.000282428922012285 0.000313863031997462 0.000354505796971896 0.000407897528885617 0.000479171539862526 0.000576300465302885 0.000710868728231552 0.000899622943163937 0.00116748914484764 0.00154969028696514 0.00209233121730099 0.0028492308420322 0.00385478815913507 0.00507773878465525 0.00635623105101023 0.00737633431678216 0.00776263767032106 0.00729307508404585 0.00608812377008493 0.00455245283882153 0.00310679822046673 0.00198501094986546 0.00122350402439984 0.000758317040419689 0.000494822570930256 0.000352784147989243 0.00027825274455602 0.000238388256252749 0.000216955659131031 0.000206066546521169 0.000201685916910992 0.000201865385524066 0.000205732089804631 0.000212944441156983;6.61838701053342e-05 7.01025507728504e-05 7.47427323384585e-05 8.02527775569489e-05 8.6850888531173e-05 9.48682059715635e-05 0.000104805641810279 0.000117463787935743 0.000134205656804952 0.000157503303839097 0.000192191671913168 0.000248470443079779 0.00034995860796674 0.000557623643111031 0.0010472054819763 0.0023827559120326 0.00646618701102641 0.0182996143309407 0.0370136521322499 0.0316302621871262 0.00952286786382182 0.000873231561732014 0.000120123862944557 9.77733386185326e-05 8.37247658102691e-05 7.38461991753231e-05 6.67918253475552e-05 6.18098105813092e-05 5.84183311485235e-05 5.62779183141628e-05 5.5146200579742e-05 5.48480712518528e-05 5.52582223504827e-05 5.62900441456122e-05 5.78901419641322e-05 6.00329788667804e-05]};

% uniform MEAN anomaly data
errDat = ...
{[0.00835315722751571 0.00849860251663198 0.00872727374023318 0.00906267153109148 0.00950291282341762 0.0100224497665314 0.0106353061343133 0.0113274514948397 0.0121129670617264 0.0129546534053091 0.0138243805278139 0.0146759291588013 0.0154993675384966 0.0162487657192872 0.0168379752251654 0.0172124039970326 0.0173741987461893 0.0173302891415809 0.0170780618386171 0.0166599457295033 0.016065630013755 0.0153546057835412 0.0146008537715214 0.0137973028093343 0.012989109604321 0.0122066204341548 0.0115001076945324 0.0108539838059208 0.0102688678849886 0.00975027397549503 0.00932643133949917 0.00897557200242682 0.00868357302525448 0.00846996667751151 0.00834471771279077;0.00208397117458786 0.00227946466097169 0.00252740589074974 0.00284265035712691 0.00324745299173903 0.0037771554895315 0.00448621355938928 0.0054527374449441 0.00678900890037692 0.00867010308115422 0.0113533006986644 0.0151840124410152 0.0206188681730047 0.0281251581017455 0.0378202087917773 0.0489663108718489 0.0592976142757883 0.0656046793386778 0.0649558137942531 0.0568968307500567 0.0443211404358473 0.0311422901565679 0.0203676393434156 0.0127901934121149 0.00797334270348168 0.00514223322185519 0.0035663584282938 0.00268089491627677 0.00219232805546634 0.00192436632635928 0.001781273332951 0.00171756178844355 0.00170991916776311 0.0017467235131451 0.0018209120458701;0.00145584369601623 0.00148058313041865 0.00151020889897238 0.00154648121462684 0.00159202496844275 0.00165087464781437 0.00172947214991635 0.00183860595217883 0.00199703615953906 0.00223930709462841 0.00263282475816183 0.00331880551816793 0.00462176131255101 0.00738418409602657 0.0141284771366559 0.0334192337644607 0.0937185005298919 0.241845746916929 0.331809160765997 0.157006054715427 0.0281248726678414 0.00202322920244659 0.000885517227337115 0.0010980241008777 0.00120706478974548 0.00126372277869676 0.00129642841451643 0.00131771268282565 0.00133361927379315 0.00134712544677392 0.00135978496277216 0.00137250051957323 0.00138586995085953 0.00140037935386923 0.00141650308744091];...
 [0.00339332423661162 0.00345243968509049 0.00354536708674118 0.0036816271706694 0.00386045958958958 0.00407147242075465 0.0043204697549016 0.00460169682620503 0.00492083305678899 0.00526278247742761 0.0056161433457495 0.00596202837787034 0.00629655316254581 0.00660113671851124 0.00684062645942083 0.00699258689894387 0.00705798910793933 0.00703990775103803 0.00693739264399444 0.00676767876064015 0.00652621708686202 0.00623738640123715 0.00593122692375125 0.00560488857136084 0.00527656761158018 0.00495861280179835 0.00467156438865839 0.00440904109206123 0.00417130050826402 0.0039606777616361 0.00378846251059351 0.00364588327628505 0.00352730304714413 0.00344063448492557 0.00338985107302598;0.00084659135110338 0.000926010080846664 0.00102673625257747 0.00115480208014956 0.0013192551872003 0.00153445153686287 0.00182251346406262 0.00221516221158914 0.00275800790422989 0.0035221465479807 0.00461207031894384 0.00616803366517559 0.00837549808455442 0.0114244735196873 0.0153626116575011 0.0198903687170765 0.0240858812145476 0.0266473567416285 0.0263838814138103 0.0231118548110167 0.0180046755967658 0.0126513255944592 0.00827437029817721 0.00519600927555423 0.0032391140220909 0.00208895282566847 0.00144875682456455 0.00108904489426748 0.000890570303466542 0.000781720166810793 0.000723599328553632 0.00069772830530893 0.000694629499209657 0.000709581524314328 0.000739722065588828;0.000591432014279602 0.000601482359677677 0.000613517753539201 0.00062825325228132 0.000646755185077517 0.000670662426192752 0.000702591651293729 0.000746925112391443 0.000811282978851394 0.000909696165055692 0.00106954182052729 0.00134817316681204 0.0018773750244715 0.00299923523432625 0.00573771366346351 0.0135679510024721 0.0380286394505695 0.0981107009491914 0.134754327513852 0.0637770379353077 0.0114266134538342 0.000821941571631532 0.000359732011467626 0.000446067094025312 0.000490367064868408 0.00051338449907845 0.000526670865120869 0.000535317267678541 0.00054177904304733 0.000547265722190683 0.000552408514003581 0.000557574108375132 0.000563005360180692 0.000568899746617897 0.000575449969624527];...
 [0.000975299812661407 0.000992294975323498 0.00101900872493438 0.00105817381672821 0.00110957236828924 0.00117021567624814 0.00124178698888631 0.00132262460832972 0.00141435509112075 0.00151264177020573 0.00161421120444937 0.00171361937282671 0.0018097704842786 0.00189733517450425 0.00196618784035747 0.00200984403935597 0.00202859659975827 0.0020233655505811 0.00199389374556362 0.00194513420442097 0.00187572909210015 0.00179271501860466 0.00170472439949268 0.00161094106890566 0.0015165743809253 0.0014251766998995 0.00134266793195921 0.00126720725786408 0.00119886953200954 0.00113833928614974 0.00108883633374272 0.0010478496372619 0.00101377302771546 0.000988877695085864 0.000974295198355713;0.000243326512340766 0.000266153197333382 0.000295104211822678 0.000331912959595669 0.000379180864904858 0.000441033950266209 0.000523830687850177 0.000636687025800748 0.000792711926906451 0.00101233640898586 0.00132559072832877 0.00177277897504718 0.00240720322363027 0.00328350408449438 0.00441537790337091 0.00571674407006582 0.00692243739881633 0.00765856306356091 0.00758284299185798 0.00664264202603541 0.0051749280812103 0.00363629579831513 0.00237826734729896 0.00149345915820832 0.000930990287731448 0.000600402491239159 0.000416395325025555 0.000313006767151664 0.000255961367018863 0.000224676633910611 0.000207972867670003 0.000200538591757781 0.000199648764246783 0.00020394635095054 0.000212609631303628;0.000169990351572474 0.00017287904119191 0.000176338275642313 0.000180573574391129 0.000185891420587017 0.000192762845915488 0.000201939896686013 0.000214682057588164 0.000233179394190755 0.000261464360666386 0.000307404937151135 0.000387483746035074 0.000539572797357243 0.000861974920270653 0.00164891164908437 0.00389876910268478 0.0109257126879416 0.0281850956662585 0.0387273473056273 0.0183326439712965 0.00328455083250237 0.000236245909323821 0.000103393829516382 0.000128209094514737 0.000140942234273637 0.000147557986493226 0.000151376742777574 0.000153861862190188 0.000155719078375079 0.000157296041157066 0.000158774173312507 0.000160258865278495 0.000161819916808401 0.000163514087198153 0.000165396762322212]};

idx = find(eccVect==e);
errDat = errDat{selObsv};
if isempty(idx)
    error('The requested eccentricity value is not tabulated!')
else
    errDat = errDat(idx,:);
end
 
 
for i = 1:length(TA)
    f0 = TA(i);
    E0 = 2 * atan(sqrt((1-e)/(1+e))*tan(f0/2));
    M0 = E0 - e*sin(E0);
    M = M0 + period;
    Mvect = linspace(M0,M,numObsv);
    Evect = kepler(Mvect,e);
    fvect = 2 * atan(sqrt((1+e)/(1-e))*tan(Evect/2));
    fvect = mod(fvect,2*pi);
    f = fvect(end);
    df = f-f0;
    df = mod(df,2*pi);
    
    % scale with measurement arc span
    error = 1 / df^1.5;
    % scale with position magnitude
%     error = error / ( (1-e^2)/(1+e*cos(fvect(selObsv))) );
    % scale with measurement magnitude
%     error = error / sqrt( (1+2*e*cos(fvect(selObsv))+e^2)/(1-e^2) );
    errVect(i) = error;
    
    dfVect(i) = df;
end

figure;
plot(TA,errVect/errVect(1)*errDat(1)*100,'LineWidth',1.5)
hold on
plot(TA,errDat*100,'LineWidth',1.5)
hold off
legend('Predicted Error','Simulated Error','Location','Best')
xlabel('True Anomaly')
ylabel('Position Error \%')
set(gca,'FontSize',16)
if e > 1
    set(gca,'YScale','log')
end
grid on