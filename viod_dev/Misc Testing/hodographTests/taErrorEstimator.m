close all
clear;clc

addpath('..\functions')
addpath('..\..\..\journal\cases')

[~,eccVect,TA,~,~] = load_orbit_cases('taVect',linspace(0,340,36));

mu = 1;
a  = 1;
e  = 0.1;

period = 0.1;
period = period * 2*pi;

numObsv = 3;
% select the nth observation's position error for comparison
selObsv = 1;

errVect = nan(size(TA));
dfVect = nan(size(TA));

% uniform TRUE anomaly data
% generated using load_orbit_cases('taVect',linspace(0,340,36));
errDat = ...
{[0.00843167887535579 0.00858187551938632 0.00880397886390709 0.00910433902013742 0.00948327931971143 0.00993062031501432 0.0104620420940402 0.0110777593830474 0.011778147893758 0.0125407656230087 0.0133445799975899 0.0141669914484145 0.0149834692269328 0.0157607295105275 0.0164402175724927 0.0169535778990955 0.0172833541569205 0.0174225536335081 0.017345088145464 0.0170508637028819 0.0165797040533367 0.0159339214990524 0.0151860419957048 0.0143614933084215 0.0134943735854853 0.0126608637567441 0.0118836984928628 0.0111754543925682 0.0105397161607045 0.0099847471673665 0.00951984039093976 0.00914487443333345 0.00884298464708947 0.00860537808576814 0.0084469918626321 0.00836777144986161;0.00204627680785391 0.00220932771516 0.00241890015337382 0.00268811827450844 0.00303620078091713 0.00349347268707504 0.0041038870625653 0.00493571280174168 0.00608823124719254 0.00770482126614591 0.00999904214759944 0.0132725561506954 0.0179204204914248 0.0244035888460873 0.0330164786098027 0.0434914045161776 0.0544431998051677 0.0631815474590916 0.0664896617942976 0.0624672704896717 0.0521456038570608 0.0389920303133354 0.0266098389371924 0.0170016718577991 0.0104793381344933 0.00649505407243704 0.00423817257561735 0.00302158801050047 0.0023831908651556 0.00204175590032164 0.00185817720522519 0.00176490536116474 0.0017273818586134 0.00172891646236853 0.00176203227251572 0.00182380558536983;0.000566840003176903 0.000600402145183606 0.000640143737743093 0.00068733522250973 0.000743845246971494 0.000812510132212842 0.000897620309102113 0.00100603210299707 0.00114941879008959 0.001348953144111 0.00164604817260326 0.00212806506716626 0.00299730814753862 0.00477601748213704 0.00896973248404216 0.020411705664166 0.0554091354164191 0.156883069375184 0.317189821983829 0.270984720337589 0.0815824275041075 0.00747921696982968 0.00102882284658583 0.000837394923527192 0.000717073144857398 0.000632466562389877 0.000572048203119904 0.000529378988782477 0.000500332124106034 0.000482000129097621 0.000472307263138675 0.000469753672904089 0.000473266205051946 0.000482103139511621 0.000495807247326145 0.000514159818230216];...
 [0.00342520459217837 0.00348623334221526 0.00357646160235465 0.00369847920297804 0.00385241993024921 0.00403415659995503 0.0042500608103004 0.00450023803011844 0.00478479613882796 0.00509461276424668 0.00542115871914764 0.00575526659534515 0.0060869101388523 0.00640264844607171 0.006678697590638 0.00688718946210672 0.00702104523647005 0.00707756696535585 0.00704607532686608 0.0069265514430938 0.00673514206689215 0.00647280791006888 0.00616899918227696 0.00583401566564335 0.00548175747765385 0.0051431148359675 0.00482734218250964 0.00453964464099997 0.00428139409187392 0.00405595433857288 0.00386714019714136 0.00371483002750186 0.00359219287191595 0.00349569850337687 0.00343139975989307 0.00339922912402679;0.000831269177518692 0.000897507042206851 0.000982642827353072 0.00109200966681987 0.00123341515539954 0.00141917739152959 0.00166715482457704 0.00200508431679924 0.00247327937810485 0.00312999849233908 0.00406197473458093 0.00539175397845667 0.00727976693583291 0.00991325910086569 0.0134118795021168 0.0176668666773724 0.0221152551102151 0.0256646174905967 0.0270086102956584 0.0253748171117111 0.0211823165779161 0.0158392572630231 0.0108094359290558 0.00690643331377653 0.00425693581885948 0.0026384219262318 0.00172164001685203 0.00122744238573098 0.000968120386740929 0.000829420334461233 0.000754848692887501 0.000716961286238355 0.000701719298856623 0.000702343395025049 0.000715796512712079 0.000740890428345186;0.000230270659566392 0.000243904769666747 0.00026004917516307 0.00027922003751275 0.000302176514734826 0.000330070760267423 0.000364645615500188 0.000408686484409033 0.00046693557770228 0.000547993870845551 0.000668683801484616 0.000864493166264748 0.00121760009977634 0.00194013343195062 0.00364357315237132 0.00829059343587778 0.0224998550285912 0.0636810737150642 0.128795203449065 0.110053743112414 0.0331332948565562 0.00303821888597085 0.00041794261333665 0.000340178897498958 0.000291300183397631 0.000256930072332672 0.000232386059696195 0.000215052336955552 0.000203252495547458 0.000195805429247442 0.000191867876266674 0.000190830578242264 0.000192257564937036 0.000195847506865195 0.000201414640443444 0.000208870116646772];...
 [0.000984460278086915 0.0010020029947587 0.00102793660811691 0.00106300689013015 0.00110725263703331 0.00115948881128305 0.00122154689837171 0.00129345985783979 0.00137525236080501 0.00146430175495519 0.00155815866417142 0.00165419003836879 0.00174950566365163 0.00184025349050383 0.00191959799910998 0.00197951532626302 0.0020179727448374 0.00203421453581041 0.00202516008252305 0.00199080671918559 0.00193579068131282 0.00186039135391325 0.00177307142351806 0.00167678723663283 0.00157554076357182 0.00147820230557162 0.00138743444730109 0.00130474678756562 0.0012305217876818 0.00116572718920186 0.00111146501828116 0.00106769013572142 0.00103244203549925 0.00100471190058226 0.000986237280662958 0.000976992437219432;0.000238921323822846 0.000257959375997448 0.000282428922012285 0.000313863031997462 0.000354505796971896 0.000407897528885617 0.000479171539862526 0.000576300465302885 0.000710868728231552 0.000899622943163937 0.00116748914484764 0.00154969028696514 0.00209233121730099 0.0028492308420322 0.00385478815913507 0.00507773878465525 0.00635623105101023 0.00737633431678216 0.00776263767032106 0.00729307508404585 0.00608812377008493 0.00455245283882153 0.00310679822046673 0.00198501094986546 0.00122350402439984 0.000758317040419689 0.000494822570930256 0.000352784147989243 0.00027825274455602 0.000238388256252749 0.000216955659131031 0.000206066546521169 0.000201685916910992 0.000201865385524066 0.000205732089804631 0.000212944441156983;6.61838701053342e-05 7.01025507728504e-05 7.47427323384585e-05 8.02527775569489e-05 8.6850888531173e-05 9.48682059715635e-05 0.000104805641810279 0.000117463787935743 0.000134205656804952 0.000157503303839097 0.000192191671913168 0.000248470443079779 0.00034995860796674 0.000557623643111031 0.0010472054819763 0.0023827559120326 0.00646618701102641 0.0182996143309407 0.0370136521322499 0.0316302621871262 0.00952286786382182 0.000873231561732014 0.000120123862944557 9.77733386185326e-05 8.37247658102691e-05 7.38461991753231e-05 6.67918253475552e-05 6.18098105813092e-05 5.84183311485235e-05 5.62779183141628e-05 5.5146200579742e-05 5.48480712518528e-05 5.52582223504827e-05 5.62900441456122e-05 5.78901419641322e-05 6.00329788667804e-05]};

% uniform MEAN anomaly data
% generated using load_orbit_cases('taVect',linspace(0,340,36));
errDat = ...
{[0.00835315722751571 0.00849331411806859 0.0087116606789194 0.00902937799179415 0.00944832944453641 0.00994319725361412 0.0105238717158442 0.0111819136377186 0.0119281679548095 0.0127336317430034 0.0135751420629625 0.0144132952342491 0.0152218265391286 0.0159884943457946 0.0166242040179 0.0170791665522626 0.0173234411255887 0.0173767756974361 0.0172348328641415 0.016905729439532 0.0164265245862193 0.0157876486819101 0.0150815810373021 0.0143331414411699 0.0135393481867564 0.0127639556631455 0.0120162668414894 0.0113470389366729 0.0107318240371387 0.0101757175331606 0.0096828276444801 0.00928394674439308 0.00894811542827987 0.00866923642570245 0.00846537350912629 0.00834471771279077;0.00208397117458786 0.00227320752101047 0.00251160155474979 0.00281248276185115 0.00319568447480895 0.00369212735822135 0.00434880391171754 0.00523413254136806 0.00644316379377079 0.00812163006016491 0.0104856626927325 0.0138313555353637 0.0185445002237383 0.025071028421423 0.0337007141532934 0.0441232749399481 0.0548642101108267 0.0632539656759628 0.0662700840173679 0.0620880182977264 0.0518399070077553 0.0389064991539161 0.0267786554510526 0.0174145131157464 0.011014067493064 0.00699423925211768 0.00464501230428213 0.00331683872121976 0.0025583924308137 0.0021342994629691 0.00189774537244863 0.00177050793215076 0.00171495023702868 0.00171090788485636 0.00174834844240238 0.0018209120458701;0.00145584369601623 0.00147981529609179 0.0015083569110956 0.00154305363450007 0.00158623883910142 0.00164144392196837 0.0017142037072168 0.00181359646639241 0.00195503681840395 0.00216609330839565 0.00249878776063946 0.00305773386678517 0.00407068379823474 0.00608959445055967 0.0106371689308316 0.0225070449458944 0.0578047896779552 0.158781406210744 0.317032706648955 0.270051174731644 0.0835640424415469 0.0107466588044091 0.00128908271846013 0.000966264963249822 0.00114088799710354 0.0012268940324148 0.00127375298201039 0.00130201264042109 0.00132119843173537 0.00133605042826838 0.00134895963145692 0.0013612224118693 0.00137361348909988 0.00138666399564474 0.0014008152675983 0.00141650308744091];...
 [0.00339332423661162 0.00345029040596622 0.00353902449341957 0.00366810448650926 0.00383828696232905 0.00403927867606718 0.00427518918832265 0.00454255269761803 0.00484575045199563 0.00517298958517897 0.00551486984597853 0.00585538573029433 0.00618377034743619 0.00649534375188549 0.0067537424628946 0.00693856773787469 0.00703749971532902 0.00705890339381227 0.00700108306479198 0.00686749712256423 0.00667284892183545 0.00641328608487673 0.00612649093777207 0.0058224894741151 0.00550012198457632 0.00518507919139023 0.00488124928841501 0.00460936458263902 0.00435940952613228 0.0041334635776205 0.00393328008947869 0.00377119935169902 0.00363472744372941 0.00352148276578891 0.00343877213434769 0.00338985107302598;0.00084659135110338 0.000923468127536798 0.00102031578175723 0.00114254638925128 0.00129822330375708 0.00149990799122086 0.00176669148662664 0.00212635478198363 0.00261751544399553 0.00329935082742537 0.00425963754932767 0.00561861762255061 0.00753296733800961 0.0101838685358095 0.0136892785488866 0.0179230891343131 0.022285796920025 0.0256925834129589 0.0269175829694109 0.0252194818534595 0.0210584515651748 0.0158053262840355 0.010878804344035 0.00707466124170122 0.0044744509906956 0.0028413461549079 0.00188695541889426 0.00134739372311473 0.0010392803426324 0.000866997112871649 0.000770907164233641 0.000719227129908404 0.000696668096516884 0.000695031258919649 0.000710241694842049 0.000739722065588828;0.000591432014279602 0.000601170428631745 0.000612765388892951 0.000626860811765713 0.000644404601725608 0.000666831280995566 0.000696389090722055 0.000736765562929147 0.000794222059007967 0.000879956205014186 0.00101509713367648 0.00124213276010045 0.00165355708544081 0.00247350035234713 0.00432016474397378 0.00913904367122413 0.0234622790543977 0.0644103658915 0.128676634223178 0.10969472932612 0.0339467498402867 0.00436611529306017 0.000523687247863903 0.000392536572473247 0.000463481656731998 0.000498422867519154 0.000517459198556663 0.00052893938868867 0.000536733290839051 0.000542766660522366 0.000548010836531729 0.000552992465052185 0.000558026244545713 0.000563327937028765 0.00056907683513278 0.000575449969624527];...
 [0.000975299812661407 0.000991677098099768 0.00101718574646428 0.00105428747646699 0.00110319968610651 0.00116096277097281 0.00122877079157535 0.00130562239157556 0.00139277334189454 0.00148683267625178 0.00158509983198925 0.00168297488516751 0.00177734942459586 0.001866919482354 0.00194120969783721 0.00199433261052457 0.00202272576648922 0.00202884079167465 0.00201219998492603 0.00197382006414127 0.00191787734051919 0.00184326973043263 0.0017608437912 0.00167347335202432 0.00158083235274525 0.00149027560117947 0.00140293595833961 0.00132478796266796 0.00125294133053778 0.00118799501309031 0.00113046485688217 0.00108387393214801 0.0010446429564848 0.00101210069019609 0.000988342914059885 0.000974295198355713;0.000243326512340766 0.000265422583247939 0.000293258826942853 0.000328390377220715 0.000373135683191425 0.000431105208333669 0.000507786234715604 0.000611161769233073 0.000752331978284469 0.000948302375426221 0.00122429878767608 0.00161487619374164 0.00216506147268902 0.00292693644542349 0.00393444029124033 0.00515131668582554 0.00640517860198566 0.00738416808239998 0.00773621714330986 0.00724825083138373 0.0060525693589361 0.00454281883916284 0.00312684996748248 0.00203343740984262 0.00128606350373162 0.000816660924904437 0.000542343382441515 0.000387261786318499 0.000298703569903725 0.000249186017305775 0.000221568974788229 0.000206716371851814 0.000200233966036024 0.000199764251969012 0.000204136105086713 0.000212609631303628;0.000169990351572474 0.000172789385379023 0.000176122029741494 0.000180173357290646 0.000185215813800582 0.000191661699344874 0.000200157172248177 0.000211762045077448 0.000228275869569814 0.000252916827706416 0.00029175730816823 0.000357007861439057 0.000475249614336813 0.000710890240953689 0.00124156876358928 0.00262625298393439 0.00674135345048768 0.0185034444455329 0.036971905304391 0.0315299924726226 0.00975799506689289 0.00125498569485754 0.000150519338793578 0.000112822718747774 0.000133214596670903 0.000143257680526785 0.000148729136732269 0.000152028756930323 0.000154268849397531 0.000156002935677692 0.000157510200084413 0.000158942011943974 0.000160388818172314 0.00016191263205924 0.000163564986208055 0.000165396762322212]};

idx = find(eccVect==e);
errDat = errDat{selObsv};
if isempty(idx)
    error('The requested eccentricity value is not tabulated!')
else
    errDat = errDat(idx,:);
end
 
 
for i = 1:length(TA)
    f0 = TA(i);
    E0 = 2 * atan(sqrt((1-e)/(1+e))*tan(f0/2));
    M0 = E0 - e*sin(E0);
    M = M0 + period;
    E = kepler(M,e);
    Mvect = linspace(M0,M,numObsv);
    Evect = kepler(Mvect,e);
    fvect = 2 * atan(sqrt((1+e)/(1-e))*tan(Evect/2));
    fvect = mod(fvect,2*pi);
    f = fvect(end);
    if f < f0
        f = f + 2*pi;
    end
    fvect = linspace(f0,f,numObsv);
    df = f-f0;
    df = mod(df,2*pi);
    
    error = 1 / df^2;
    error = error / (1-e^2) * (1+e*cos(f0));
    error = error * sqrt((1-e^2) / (1+2*e*cos(f0)+e^2));
    errVect(i) = error;
    
    dfVect(i) = df;
end

figure;
plot(TA,errVect/errVect(1)*errDat(1)*100,'LineWidth',1.5)
hold on
plot(TA,errDat*100,'LineWidth',1.5)
hold off
legend('Predicted Error','Simulated Error')
xlabel('True Anomaly')
ylabel('Position Error \%')
set(gca,'FontSize',16)
if e < 0.2
    set(gca,'YScale','log')
end
grid on